\setuppapersize [A4]

\mainlanguage[cn]
\language[cn]
\enableregime[utf]
\setscript[hanzi] % hyphenation

\usetypescriptfile[type-imp-myfonts]
\usetypescript[myfonts]
\setupbodyfont[myfonts,rm,12pt]

\usecolors[crayola]


%%%%%%%%%%%%
% 页脚页眉
\setupheader
  [text]
  [before={\startframed[frame=off,bottomframe=on,framecolor=black,]},
   after={\stopframed},
  ]
\setupfooter
  [text]
  [before={\startframed[frame=off,bottomframe=off,topframe=on,framecolor=black,]},
   after={\stopframed},
  ]
\setupheadertexts[]
\setupheadertexts[{\tf\bf\ss \somenamedheadnumber{chapter}{current}. \getmarking[chapter]}][]
\setupfootertexts[]
\setupfootertexts[{\setupinteraction[color=FuzzyWuzzy] \ss
  \goto{\doifmodeelse{sc}{请到莊春江工作站阅读最新修订经文}{請到莊春江工作站閱讀最新訂正經文}}
  [url(https://agama.buddhason.org/)]}][{\tfa \it \pagenumber}]
% 页脚页眉
%%%%%%%%%%%


%%%%%%%%%%%%%%%
% PDF 属性信息
\setupinteraction[focus=standard] % 重要功能！添加上后才能连接到位置！
\setupinteraction[state=start,style=normal]
\setupinteraction[
    title={相應部},
    author={莊春江(譯)},
    subtitle={佛教},
    keyword={南傳佛教,尼柯耶,經藏},
    creator={https://github.com/meng89/nikaya/tree/dev},
]
\startmode [sc]
  \setupinteraction[
    title={相应部},
    author={莊春江(译)},
    subtitle={佛教},
    keyword={南传佛教,尼柯耶,经藏},
  ]
\stopmode
% PDF 属性信息
%%%%%%%%%%%%%%%


%%%%%%%%%%%%
% PDF书签
\definelist[tobias]

\placebookmarks[part,chapter,section,subsection,tobias][chapter][number=no]

\setupinteractionscreen[option=bookmark]
\enabledirectives[references.bookmarks.preroll]


\defineresetset[default][1,0,0][1] %% reset part,  but not chapter, section
\setuphead[sectionresetset=default]

\defineheadplacement[activityhead][vertical]#1#2{%
  \labeltext{\currenthead}\hskip\numberheaddistance #1%
}
% PDF书签
%%%%%%%%%%%


\setuphead[part]      [number=no,alternative=middle,style=\tfd\bf\ss,placehead=yes,header=empty,footer=empty]


%为什么有下面这一大段，是为了自定义标题格式，为了分开number和名字，为了自动给sutta加上 SN.x.x 这样的label
\defineheadalternative
  [centered]
  [alternative=vertical,
   renderingsetup=headrenderings:centered]
\startsetups[headrenderings:centered]
    \vbox {
        \headsetupspacing
        \veryraggedcenter
        \let\\\endgraf
        \let\crlf\endgraf
        %\fakeheadnumbercontent
        % \headnumbercontent -> 1.1.1 ，不喜欢这个样式
        \begstrut
        \somenamedheadnumber{chapter}{current}. \headtextcontent
        \endstrut
    }
\stopsetups


\setuphead[chapter]   [alternative=centered, style=\tfc\bf\ss,page=no,header=empty,footer=empty]
\setuphead[section]   [number=no,alternative=middle,style=\tfb\bf\ss]
\setuphead[subsection][style=\tf\bf\ss,]



\define[3]\pian{\part[title=#1(#2-#3)]}
\define[2]\xiangying{\chapter[title=#2, bookmark=#1. #2]}
\define[3]\pin{\section[title=#1(#2-#3)]}
\define[3]\sutta{\subsection[reference=SN.\somenamedheadnumber{chapter}{current}.#1,
     title={\startlua if #1==#2 then context("#1") else context("#1-#2") end \stoplua}. #3]}


% 绿
\define[1]\suttaref{\setupinteraction[color=PineGreen]\goto{#1}[#1]}
% 黄
\define[2]\ccchref{\setupinteraction[color=FuzzyWuzzy]\goto{#1}[url(#2)]}
% 蓝
\define[2]\twnr{\setupinteraction[color=MidnightBlue]\goto{#1}[#2]}


\define[1]\noteTitle{\part[title=#1]}


\define[1]\subnoteref{\textreference[#1]{\null}}

%%%%%%%
%
\define[1]\NoteSubKeyHead{{\it #1}}
\define[1]\NoteKeywordAgamaHead{{#1}}
\define[1]\NoteKeywordNikayaHead{{#1}}

\define[1]\NoteSubEntryKey{{\sl #1}}
\define[1]\NoteKeywordAgama{{#1}}
\define[1]\NoteKeywordNikaya{{#1}}
\define[1]\NoteKeywordBhikkhuBodhi{{#1}}
\define[1]\NoteKeywordBhikkhuNanamoli{{#1}}


\define\newline{\par}

\definestartstop[ReadNote][style=\tfa,]

\definestartstop[Note]
  [style=\small,
      before=\blank\startpacked,
   after=\stoppacked\blank]


\definesymbol [none] []
\defineitemgroup [noteitems]
\setupitemgroup [noteitems][each] [packed] [distance=-10em,symbol=none,inner={\switchtobodyfont[10pt]}]


\definemakeup [homage] [align=middle, style=\tfd,]

%%%%%%
% 附录
\definehead
  [appendix]
  [part]
  [placehead=empty,
   before={},
   after={}]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\startdocument


\startstandardmakeup
\bookmark[tobias]{封面}
  \raggedcenter
  \vfill
  \blank[-3*big]
  \definedfont[SansBold at 140pt]\setstrut \strut \doifmodeelse{sc}{相应部}{相應部}
  \blank[-3*big]
  \definedfont[SansBold at 45pt]\setstrut \strut Saṃyutta ~ Nikāya
  \blank[3*big]
  \definedfont[Sans at 25pt] \setstrut \strut \doifmodeelse{sc}{机转简体版本}{傳統中文版}
  \blank[18*big]
  \definedfont[Sans at 20pt] \setstrut \strut 莊春江 ~ \doifmodeelse{sc}{译}{譯}
  \blank[-2*small]
  \definedfont[SansBold at 21pt] \setstrut \strut $date
  \vfill
\stopstandardmakeup


\part{閱讀說明}
\input{read_note.tex}


\startmakeup[homage]
\bookmark[tobias]{禮敬}
\vfill
\blank[-25*big]
$homage
\vfill
\stopmakeup


\input{$suttas}
\page


% 附录一：注解
\setupheadertexts[註解][]
\noteTitle{註解}
\input{$localnotes}

\setupheadertexts[全局註解][]
\noteTitle{全局註解}
\input{$globalnotes}

% 附录二：巴利经文
% todo

\part{PDF 制作说明}
\input{creator_note.tex}

\stopdocument
